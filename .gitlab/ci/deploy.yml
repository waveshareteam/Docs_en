deploy_to_test_server:
  stage: deploy
  rules:
    - if: $CI_COMMIT_BRANCH == "dev"
      changes:
        paths: ["**/*"]
    - if: $CI_PIPELINE_SOURCE == "web"
      when: manual
  before_script:
    - '[[ "${TARGET_DIR:?}" =~ ^(/|/root|/home/[^/]+)$ ]] && { echo "Protected PATH!"; exit 1; }'
    - sed -i 's/deb.debian.org/mirrors.aliyun.com/g' /etc/apt/sources.list.d/debian.sources 2>/dev/null || sed -i 's/deb.debian.org/mirrors.aliyun.com/g' /etc/apt/sources.list
    - command -v rsync >/dev/null || ( apt-get update -y && apt-get install rsync -y )
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | base64 -d | ssh-add -
    - mkdir -p ~/.ssh && chmod 700 ~/.ssh
    - echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config
  script:
    - npm config set registry https://registry.npmmirror.com
    - npm ci --verbose --prefer-offline
    - npm run build
    - rsync -avz --delete -e "ssh -p $SSH_PORT" build/ $SSH_USER@$SSH_HOST:$TARGET_DIR